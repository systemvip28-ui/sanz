<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sanz Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
body { margin:0; font-family: 'Inter', sans-serif; background:#121212; color:#eee; }
.container { display:flex; flex-direction: row; height:100vh; }
.sidebar { width:250px; background:#1f1f1f; display:flex; flex-direction:column; transition:0.3s; }
.sidebar-header { background:#075e54; padding:15px; text-align:center; font-weight:600; position:relative; }
.sidebar-header span#serverStatus { position:absolute; right:15px; top:50%; transform:translateY(-50%); font-size:0.8rem; }
.user-box { padding:10px; display:flex; flex-direction:column; gap:8px; }
.user-box input { padding:10px; border-radius:6px; border:none; background:#333; color:white; }
.user-box button { padding:10px; border:none; border-radius:6px; background:#128c7e; color:white; cursor:pointer; }
.user-box button:hover { background:#0f7664; }
.online-list { flex:1; overflow-y:auto; padding:10px; }
.online-item { display:flex; align-items:center; padding:8px; border-radius:6px; cursor:pointer; position:relative; }
.online-item:hover { background:#2c2c2c; }
.online-item img { width:36px; height:36px; border-radius:50%; margin-right:10px; }
.user-status { width:10px; height:10px; border-radius:50%; position:absolute; left:30px; bottom:6px; border:1px solid #121212; }
.chat-area { flex:1; display:flex; flex-direction:column; }
.chat-header { background:#075e54; padding:12px 15px; font-weight:600; }
.messages { flex:1; padding:10px; overflow-y:auto; display:flex; flex-direction:column; gap:6px; background:#121212; }
.msg { max-width:70%; padding:10px 14px; border-radius:18px; word-wrap:break-word; font-size:0.95rem; }
.sent { background:#1f6b3d; align-self:flex-end; }
.received { background:#2c2c2c; align-self:flex-start; }
.chat-input { display:flex; padding:10px; margin-bottom: 100px; background:#1f1f1f; }
.chat-input input { flex:1; padding:10px; border-radius:18px; border:none; background:#333; color:white; }
.chat-input button { padding:10px 16px; margin-left:8px; border-radius:50%; border:none; background:#075e54; color:white; cursor:pointer; }
.chat-input button:hover { background:#0b5e45; }

/* Responsive */
@media(max-width:768px){
    .container { flex-direction:column; }
    .sidebar { width:100%; height:auto; }
    .chat-area { flex:1; }
}
</style>
</head>
<body>
<div class="container">
    <div class="sidebar">
        <div class="sidebar-header">
            Sanz
            <span id="serverStatus">ðŸ”´ Offline</span>
        </div>
        <div class="user-box">
            <input id="username" placeholder="Nama Anda">
            <button onclick="joinChat()">Gabung</button>
        </div>
        <div class="online-list" id="onlineList"></div>
    </div>
    <div class="chat-area">
        <div class="chat-header" id="chatTitle">Global Chat</div>
        <div class="messages" id="messages"></div>
        <div class="chat-input">
            <input type="text" id="msgInput" placeholder="Ketik pesan..." disabled>
            <button onclick="sendMessage()" id="btnSend" disabled>âž¤</button>
        </div>
    </div>
</div>

<script>
let ws;
let username = "";
let currentTarget = "global";

// Gunakan localhost untuk testing
const SERVER_IP = "localhost";
const SERVER_PORT = 8081;

// Auto reconnect jika username tersimpan
window.onload = () => {
    const saved = localStorage.getItem("username");
    if (saved) {
        username = saved;
        document.getElementById("username").value = saved;
        joinChat();
    }
};

// Status server
function setServerStatus(isOnline) {
    const status = document.getElementById("serverStatus");
    status.textContent = isOnline ? "ðŸŸ¢ Online" : "ðŸ”´ Offline";
}

function joinChat() {
    username = document.getElementById("username").value.trim();
    if (!username) return alert("Nama wajib diisi!");
    localStorage.setItem("username", username);
    connectWebSocket();
}

function connectWebSocket() {
    ws = new WebSocket("ws://" + SERVER_IP + ":" + SERVER_PORT);

    ws.onopen = () => {
        console.log("Connected to WS at " + SERVER_IP + ":" + SERVER_PORT);
        setServerStatus(true);
        ws.send(JSON.stringify({ type: "join", user: username }));
        document.getElementById("msgInput").disabled = false;
        document.getElementById("btnSend").disabled = false;
    };

    ws.onclose = () => {
        console.log("Disconnected, reconnecting in 3s...");
        setServerStatus(false);
        document.getElementById("msgInput").disabled = true;
        document.getElementById("btnSend").disabled = true;
        setTimeout(connectWebSocket, 3000);
    };

    ws.onerror = err => { 
        console.error(err); 
        setServerStatus(false);
        ws.close(); 
    };

    ws.onmessage = e => {
        let msg = JSON.parse(e.data);

        if (msg.type === "onlineList") { updateOnlineList(msg.users); return; }
        if (msg.type === "history") { msg.chats.forEach(c => showMessage(c.user, c.text, false)); return; }
        if (msg.type === "privateHistory") { msg.chats.forEach(c => showMessage(c.user, c.text, true)); return; }
        if (msg.type === "chat") { showMessage(msg.user, msg.text, false); return; }
        if (msg.type === "private") { showMessage(msg.user, msg.text, true); return; }
    };
}

// Update list user online
function updateOnlineList(allUsers) {
    const box = document.getElementById("onlineList");
    box.innerHTML = "";

    allUsers.forEach(u => {
        if(u === username) return;

        const div = document.createElement("div");
        div.className = "online-item";

        div.innerHTML = `
            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS1mZ1UVyMaaAinSb_x3Cn0y-5tTGQMcosa6sbqD5Y2mg&s=10">
            <span>${u}</span>
            <span class="user-status" style="background-color:#1f6b3d"></span>
        `;
        div.onclick = () => openPrivateChat(u);
        box.appendChild(div);
    });
}

function openPrivateChat(target) {
    currentTarget = target;
    document.getElementById("chatTitle").textContent = "Chat dengan: " + target;
    document.getElementById("messages").innerHTML = "";
    ws.send(JSON.stringify({ type: "getPrivateHistory", with: target }));
}

function showMessage(user, text, isPrivate) {
    let box = document.getElementById("messages");
    let div = document.createElement("div");
    div.className = "msg " + (user === username ? "sent" : "received");
    div.textContent = user + ": " + text;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
}

function sendMessage() {
    let text = document.getElementById("msgInput").value.trim();
    if (!text) return;

    if (currentTarget !== "global") {
        ws.send(JSON.stringify({ type: "private", user: username, to: currentTarget, text: text }));
        showMessage(username, text, true);
    } else {
        ws.send(JSON.stringify({ type: "chat", user: username, text: text }));
    }

    document.getElementById("msgInput").value = "";
}
</script>
</body>
  </html>
  
